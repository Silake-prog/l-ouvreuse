---
import { formatDate } from "../lib/utils";

const { post, rubriqueEntry } = Astro.props;

// URL de la page d’article
const url = `/articles/${post.slug}/`;

// Image + alt + crédit (tous optionnels)
const imgSrc: string = post.data.image ?? "/brand/placeholder.svg";
const alt: string = post.data.imageAlt ?? post.data.title ?? "";
const credit: string | undefined = post.data.imageCredit;

// Label de rubrique
const rubriqueLabel: string = rubriqueEntry?.data?.title ?? post.data.rubrique ?? "";
---

<a class="card article-card" href={url} aria-label={`Lire : ${post.data.title}`}>
  <figure class="media">
    <img
      src={imgSrc}
      alt={alt}
      loading="lazy"
      decoding="async"
      onError={(e) => {
        // Si l’image échoue, bascule sur le placeholder et adapte le rendu
        const el = e.currentTarget as HTMLImageElement;
        if (el.src.endsWith("/brand/placeholder.svg")) return;
        el.src = "/brand/placeholder.svg";
        el.classList.add("is-fallback");
      }}
    />
    {credit && <figcaption class="credit">{credit}</figcaption>}
  </figure>

  <div class="meta">
    {rubriqueLabel && <span class="badge">{rubriqueLabel}</span>}
    <h3>{post.data.title}</h3>
    {post.data.excerpt && <p class="excerpt">{post.data.excerpt}</p>}
    {post.data.date && <small class="date">{formatDate(post.data.date)}</small>}
  </div>
</a>

<style>
.article-card {
  display: grid;
  gap: .6rem;
  text-decoration: none;
  color: inherit;
}

/* Image + crédit */
.article-card .media {
  margin: 0;
  display: flex;
  flex-direction: column;
}
.article-card img {
  width: 100%;
  aspect-ratio: 16/9;
  object-fit: cover;
  border-radius: 12px;
  background: linear-gradient(135deg, #ffffff, #f8f6ee);
  border: 1px solid #e6e3d6;
}
.article-card img.is-fallback {
  /* Quand on tombe sur le placeholder, on évite l’effet “image rognée” */
  object-fit: contain;
  padding: 12px;
}
.article-card .credit {
  margin-top: .25rem;
  font-size: .75rem;
  color: #666;
  text-align: right;
  font-style: italic;
}

/* Meta */
.article-card .meta { display: grid; gap: .2rem; }
.article-card h3 { margin: .2rem 0 .1rem; }
.article-card .excerpt { margin: .1rem 0 .1rem; color: #333; }
.article-card .date { color: #666; }
</style>